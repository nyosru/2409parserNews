name: Deploy livewire

on:
  push:
    branches:
      - cicd_to_ihc_docker24

env:
  VPS_IP: 91.218.230.97
  VPS_USERNAME: root
  DIR: /home/2409parserNews
  GIT_BRANCH: origin/cicd_to_ihc_docker24
  CONTAINER: web_scraper2

jobs:

  deploy:
    runs-on: ubuntu-latest
    steps:

#      - name: Set up Docker Buildx
#        uses: docker/setup-buildx-action@v1
#
#      - name: Install Docker Compose
#        run: |
#          sudo apt-get update
#          sudo apt-get install -y docker-compose

      - name: "refresh git & restart docker"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VPS_IP }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd ${{ env.DIR }}
            git fetch --all
            git reset --hard ${{ env.GIT_BRANCH }}


  deploy2:
    runs-on: ubuntu-latest
    needs: deploy
    steps:

      - name: "restart composer"
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VPS_IP }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            cd /home/docker
            docker-compose rm -f web_scraper2
            docker-compose up --build

#            docker-compose up -d --force-recreate ${{ env.CONTAINER }}
#            docker-compose up -d

#            make d
  #            docker-compose down --rmi all --volumes
#            docker-compose up --build -d --force-recreate ${{ env.CONTAINER }}

#            docker-compose up -d
#            docker-compose up --build --force-recreate ${{ env.CONTAINER }}

#            docker exec ${{ env.CONTAINER }} composer i --no-dev
#            docker exec ${{ env.CONTAINER }} php artisan migrate
#            docker exec ${{ env.CONTAINER }} php artisan view:clear
#            docker exec ${{ env.CONTAINER }} php artisan cache:clear
#
## deploy_composer_stop:
#  #   runs-on: ubuntu-latest
#  #   needs: deploy
#  #   steps:
#  #     - uses: appleboy/ssh-action@master
#  #       with:
#  #         host: ${{ env.VPS_IP }}
#  #         username: ${{ env.VPS_USERNAME }}
#  #         key: ${{ secrets.DEPLOY_KEY }}
#  #         script: |
#  #           cd ${{ env.DIR }}
#  #           docker-compose down
#
#  # deploy_composer:
#  #   runs-on: ubuntu-latest
#  #   needs: deploy_composer_stop
#  #   steps:
#  #     - uses: appleboy/ssh-action@master
#  #       with:
#
#  #         host: ${{ env.VPS_IP }}
#  #         username: ${{ env.VPS_USERNAME }}
#  #         key: ${{ secrets.DEPLOY_KEY }}
#
#  #         script: |
#  #           cd ${{ env.DIR }}
#  #           make prod

  sms_start:
    runs-on: ubuntu-latest
    steps:
      - name: send telega
        uses: appleboy/telegram-action@master
        with:
          # to: ${{ secrets.TELEGRAM_TO }}
          # phpcat,
          to: 360209578
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ¥ğŸ¥ğŸ¥ ${{ github.repository }}
            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
            ğŸ‘¨ğŸ»â€ğŸ’» ${{github.actor}} (${{ github.run_id }})

  sms_end:
    runs-on: ubuntu-latest
    # needs: [deploy_composer, deploy_npm]
    needs: deploy2
    steps:
      - name: send telega
        uses: appleboy/telegram-action@master
        with:
          # phpcat,
          to: 360209578
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ€ğŸ€ğŸ€ ${{ github.repository }}
            ${{ github.event_name }} > ${{ github.event.head_commit.message }}
            ğŸ‘¨ğŸ»â€ğŸ’» ${{github.actor}} (${{ github.run_id }})
